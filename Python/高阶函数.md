### 高阶函数（Higher-Order Function）

这是函数式编程中的一个核心概念，但它的思想非常通用和强大，在许多现代编程语言（包括 C++）中都有广泛应用。

### 核心定义

**高阶函数**是指**至少满足以下一个条件的函数**：

1. **接收一个或多个函数作为输入（参数）。**
2. **返回一个函数作为输出（返回值）。**

简单来说，高阶函数就是**把函数当作数据来处理**的函数。它允许你将行为（函数）作为参数传递，或者将行为封装后返回。

------

### 为什么高阶函数如此重要？

高阶函数是实现**抽象、代码复用和灵活性**的强大工具。它让你可以编写更通用、更具表达力的代码。

1. **抽象出通用模式**：很多算法的核心逻辑是相似的，只是其中的某个具体步骤不同。高阶函数可以将这个通用逻辑抽象出来，而把变化的部分作为函数参数传入。
2. **实现代码复用**：通过将函数作为参数，你可以创建一个 “框架” 函数，然后用不同的 “策略” 函数来填充它，从而复用这个框架。
3. **创建更具表达力的代码**：使用高阶函数，你可以写出更接近自然语言、意图更清晰的代码。

------

### C++ 中的高阶函数示例

C++ 通过**函数指针**、**函数对象（Functor）\**和\**Lambda 表达式**来支持高阶函数。

#### 示例 1：函数作为参数

这是最常见的形式。标准库中充满了这样的例子。

**1. `std::for_each`**

`std::for_each` 是一个高阶函数，它接收一个范围（容器的开始和结束迭代器）和一个函数。它会对范围内的每个元素执行这个函数。



```cpp
#include <iostream>
#include <vector>
#include <algorithm> // for std::for_each

// 一个普通的函数，用于打印
void print_int(int x) {
    std::cout << x << " ";
}

int main() {
    std::vector<int> numbers = {1, 2, 3, 4, 5};

    std::cout << "Printing numbers: ";
    // 调用高阶函数 std::for_each，并将 print_int 函数作为参数传入
    std::for_each(numbers.begin(), numbers.end(), print_int);
    std::cout << std::endl;

    std::cout << "Printing squared numbers: ";
    // 更常见的是使用 Lambda 表达式，它能就地定义匿名函数
    std::for_each(numbers.begin(), numbers.end(), [](int x) {
        std::cout << x * x << " ";
    });
    std::cout << std::endl;

    return 0;
}
```

在这个例子中，`std::for_each` 本身是通用的 “遍历” 框架，而你传入的 `print_int` 或 Lambda 表达式则是具体的 “行动”。

**2. `std::sort` 与自定义比较器**

`std::sort` 默认按升序排序，但它也接受一个可选的第三个参数：一个比较函数。这个比较函数决定了排序的规则。

```cpp
#include <iostream>
#include <vector>
#include <algorithm>

int main() {
    std::vector<int> numbers = {5, 2, 8, 1, 9, 4};

    // 默认排序（升序）
    std::sort(numbers.begin(), numbers.end());
    // 输出: 1 2 4 5 8 9

    // 使用 Lambda 作为比较器，实现降序排序
    std::sort(numbers.begin(), numbers.end(), [](int a, int b) {
        return a > b; // 如果 a 应该在 b 前面，则返回 true
    });

    // 输出: 9 8 5 4 2 1
    for (int num : numbers) {
        std::cout << num << " ";
    }
    std::cout << std::endl;

    return 0;
}
```

这里，`std::sort` 是高阶函数，而那个返回 `a > b` 的 Lambda 表达式是我们传入的自定义行为。

#### 示例 2：函数作为返回值

这种形式允许你根据某些条件 “制造” 出一个特定的函数。

假设我们需要一个函数，它能根据输入的运算符（`"+"` 或 `"*"`）返回一个对应的加法或乘法函数。

在 C++ 中，返回一个函数有点 tricky，因为函数本身不能直接作为返回值，但我们可以返回一个**函数对象**（如 `std::function`）或一个**Lambda**。

```cpp
#include <iostream>
#include <functional> // for std::function

// 这个函数根据传入的字符串返回一个函数对象
std::function<int(int, int)> get_operation(const std::string& op) {
    if (op == "+") {
        // 返回一个执行加法的 Lambda
        return [](int a, int b) { return a + b; };
    } else if (op == "*") {
        // 返回一个执行乘法的 Lambda
        return [](int a, int b) { return a * b; };
    } else {
        // 返回一个默认的错误处理函数
        return [](int a, int b) { 
            std::cerr << "Unknown operation!" << std::endl;
            return 0; 
        };
    }
}

int main() {
    // get_operation 是一个高阶函数，它返回了一个函数
    auto add_func = get_operation("+");
    auto multiply_func = get_operation("*");

    std::cout << "3 + 4 = " << add_func(3, 4) << std::endl;         // 输出: 3 + 4 = 7
    std::cout << "3 * 4 = " << multiply_func(3, 4) << std::endl;   // 输出: 3 * 4 = 12

    // 也可以直接调用返回的函数
    std::cout << "5 + 6 = " << get_operation("+")(5, 6) << std::endl; // 输出: 5 + 6 = 11

    return 0;
}
```

在这个例子中，`get_operation` 是一个高阶函数。它根据输入动态地 “生成” 并返回了一个特定功能的函数。

------

### 高阶函数与函数式编程

高阶函数是函数式编程的基石。许多核心的函数式编程概念，如 **map**、**filter** 和 **reduce**，都是高阶函数。

- **`map`**：接收一个函数和一个列表，将该函数应用到列表的每个元素上，返回一个新的列表。在 C++ 中是 `std::views::transform`。
- **`filter`**：接收一个谓词函数（返回布尔值的函数）和一个列表，返回一个只包含满足谓词条件的元素的新列表。在 C++ 中是 `std::views::filter`。
- **`reduce`**：接收一个函数和一个列表，将该函数反复应用于列表的元素，将其 “折叠” 或 “归约” 为一个单一的值。在 C++ 中是 `std::accumulate`。

### 总结

| 特性           | 普通函数                             | 高阶函数                                              |
| -------------- | ------------------------------------ | ----------------------------------------------------- |
| **操作的数据** | 基本数据类型（int, double 等）、对象 | **函数**（以及普通数据）                              |
| **能力**       | 接收和返回数据                       | **接收和 / 或返回函数**                               |
| **目的**       | 执行具体任务                         | **抽象和组合行为**，实现代码复用和灵活性              |
| **C++ 示例**   | `int add(int a, int b)`              | `std::for_each`, `std::sort`, `std::views::transform` |

理解并熟练运用高阶函数，能让你写出更简洁、更灵活、更具表达力的 C++ 代码，尤其是在处理集合数据和实现通用算法时。